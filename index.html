<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111827">
    <title>Calculadora Elite Metals</title>
    <style>
        :root {
            /* COLORES BASADOS EN EL LOGO ELITE METALS */
            --brand-red: #d32f2f;       /* Rojo del logo */
            --brand-red-dark: #b71c1c;  /* Rojo más oscuro para hover */
            --brand-black: #111827;     /* Negro metálico */
            --bg-color: #f3f4f6;        /* Gris muy claro para el fondo */
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --success: #059669;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- NUEVO ENCABEZADO ESTILO "ELITE" --- */
        header {
            background-color: var(--brand-black);
            color: white;
            padding: calc(0.8rem + env(safe-area-inset-top)) 1rem 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-bottom: 3px solid var(--brand-red);
        }

        .brand-container {
            display: flex;
            flex-direction: column;
            line-height: 1;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .text-elite { color: var(--brand-red); }
        .text-metals { color: #ffffff; }

        .brand-subtitle {
            font-size: 0.55rem;
            color: #9ca3af;
            letter-spacing: 2px;
            margin-top: 2px;
            text-transform: uppercase;
        }

        .app-badge {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        /* Títulos de secciones */
        h2 { 
            font-size: 1rem; 
            margin: 0 0 1rem 0; 
            color: var(--brand-black); 
            border-left: 4px solid var(--brand-red); /* Detalle rojo a la izquierda */
            padding-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        
        select, input:not([type="checkbox"]) {
            width: 100%;
            padding: 14px; /* Un poco más alto para dedos */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px; 
            background-color: #fff;
            appearance: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--brand-red);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }

        .input-group { display: flex; gap: 8px; }
        .input-group input { flex: 1; }
        .input-group select { width: 90px; background-color: #f9fafb; }

        /* BOTÓN ESTILO BRAND */
        .btn-main {
            width: 100%;
            background: linear-gradient(135deg, var(--brand-red) 0%, var(--brand-red-dark) 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
            transition: transform 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-main:active { transform: scale(0.98); }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .result-box {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .result-box span { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; text-transform: uppercase; }
        .result-box strong { display: block; font-size: 1.2rem; color: var(--brand-black); }
        
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--brand-red) !important; }

        .details-toggle {
            background: none;
            border: none;
            color: var(--brand-red);
            font-size: 0.85rem;
            width: 100%;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }
        
        .row-item { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px dashed #e5e7eb; padding-bottom: 5px; }
        .row-item:last-child { border-bottom: none; }
        
        .row-item.highlight { 
            background: #fff1f2; /* Fondo rojizo muy suave */
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #fecdd3; 
            font-weight: 700; 
            color: var(--brand-red-dark); 
        }
        
        .hidden { display: none !important; }
        
        /* Checkbox estilo Elite */
        .checkbox-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 15px 0; 
            cursor: pointer; 
            border-top: 1px solid #eee;
            margin-top: 10px;
        }
        
        input[type="checkbox"] {
            appearance: auto;
            width: 22px;
            height: 22px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--brand-red); /* Checkbox rojo */
        }
        
        /* Input manual destacado */
        #manualCost {
            background-color: #fff;
            border: 1px dashed var(--brand-red);
        }
    </style>
</head>
<body>

<header>
    <div class="brand-container">
        <div class="brand-title">
            <span class="text-elite">ELITE</span> <span class="text-metals">METALS</span>
        </div>
        <div class="brand-subtitle">GROUP CORP &bull; FINANZAS</div>
    </div>
    <div class="app-badge">
        Calculadora
    </div>
</header>

<div class="container">
    <div class="card">
        <h2><i style="color:var(--brand-red)">&#9881;</i> Parámetros</h2>
        
        <div class="form-group">
            <label>Material</label>
            <select id="material"></select>
        </div>

        <div class="form-group">
            <label>Destino</label>
            <select id="destino" disabled><option>Seleccione material primero</option></select>
        </div>

        <div class="form-group">
            <label>Cantidad</label>
            <div class="input-group">
                <input type="number" id="quantity" placeholder="0" inputmode="decimal">
                <select id="unit">
                    <option value="TM">TM</option>
                    <option value="LBS">LBS</option>
                </select>
            </div>
            <small style="color:var(--text-light); font-size:0.75rem; display:block; margin-top:4px;">Capacidad contenedor: 27.5 TM</small>
        </div>

        <div class="results-grid">
            <div class="form-group">
                <label id="lblBuy">Compra (USD)</label>
                <input type="number" id="purchasePrice" placeholder="0.00" inputmode="decimal">
            </div>
            <div class="form-group">
                <label id="lblSell">Venta (USD)</label>
                <input type="number" id="salePrice" placeholder="0.00" inputmode="decimal">
            </div>
        </div>

        <div class="form-group">
            <label>Margen Utilidad Deseado (%)</label>
            <input type="number" id="profitMargin" placeholder="Opcional" inputmode="decimal">
        </div>

        <button class="btn-main" id="btnCalculate">CALCULAR</button>
    </div>

    <div id="resultsArea" class="hidden">
        
        <div class="card">
            <h2>Resultados Financieros</h2>
            <div class="results-grid" style="margin-bottom: 1rem;">
                <div class="result-box">
                    <span>Utilidad Bruta</span>
                    <strong id="resGrossProfit">0</strong>
                </div>
                <div class="result-box">
                    <span>ROI</span>
                    <strong id="resRoi">0%</strong>
                </div>
            </div>
            
            <div id="suggestionsContainer" class="hidden">
                <div class="row-item">
                    <span>Precio Venta Sugerido:</span>
                    <strong style="color:var(--success)" id="resIdealSell">0</strong>
                </div>
                <div class="row-item">
                    <span>Precio Compra Sugerido:</span>
                    <strong style="color:var(--success)" id="resIdealBuy">0</strong>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Logística & Costos</h2>
            
            <div class="row-item highlight">
                <span>Total Logística:</span>
                <span id="resTotalLogistic">0 USD</span>
            </div>
            <div class="row-item">
                <span id="lblLogisticUnit">Costo por TM:</span>
                <strong id="resLogisticUnit">0 USD</strong>
            </div>
            <div class="row-item">
                <span>Contenedores:</span>
                <span id="resContainers">0</span>
            </div>

            <button type="button" class="details-toggle" onclick="document.getElementById('detailsList').classList.toggle('hidden')">
                Ver/Ocultar Desglose &#9662;
            </button>

            <div id="detailsList" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="pickupOverride">
                <label for="pickupOverride">Recogida Proveedor (+$500/cont)</label>
            </div>
            
            <div class="form-group" style="margin-top:10px;">
                <label style="font-size:0.8rem; color:var(--brand-red)">Ajuste Manual Costo Total:</label>
                <input type="number" id="manualCost" placeholder="Escriba para sobreescribir cálculo" inputmode="decimal">
                <small id="manualWarning" class="hidden" style="color:var(--brand-red); font-size:0.75rem; font-weight:bold;">*Sobreescribe desglose y recogida</small>
            </div>
        </div>
    </div>
</div>

<script id="csv-data" type="text/plain">
MATERIAL;FLETE MARITIMO;SALIDA;BOLIPUERTO;INTER SHIP;COMISION;ORIGEN Y PUERTO;PAIS Y PUERTO DESTINO;ACARREO;KCI;ARANCEL;FLETE MIAMI
HIERRO;540;1.000;500;55;50;VENEZUELA, LA GUAIRA;Mundra, India;;;;
ACERO;100;0;0;60;0;PUERTO RICO, PUERTO DE SAN JUAN;Kaohsiung, Taiwan;;;;
ACR;0;0;0;0;0;ESTADOS UNIDOS, MIAMI;Loxley, Estados Unidos;0;0;0;950
RIELES;1.815;1.580;500;55;50;VENEZUELA, LA GUAIRA;Qasim, Pakistan;;;;
ALUMINIO DURO;920;1.750;500;55;50;VENEZUELA, LA GUAIRA;Ennore, India;;;;
ALUMINIO DURO;80;1.750;500;55;50;VENEZUELA, LA GUAIRA;Kaohsiung, Taiwan;;;;
ALUMINIO DURO;720;1.750;500;55;50;VENEZUELA, LA GUAIRA;Mundra, India;;;;
COBRE;0;0;0;0;0;ESTADOS UNIDOS, MIAMI;East Hartford, Estados Unidos;0;0;0;644
ALUMINIO T/T;1.177;1.750;500;55;50;VENEZUELA, LA GUAIRA;Estambul, Turquia;;;;
ALUMINIO T/T;80;1.750;500;55;50;VENEZUELA, LA GUAIRA;Kaohsiung, Taiwan;;;;
EC WIRE;1.000;0;0;950;0;COLOMBIA, BARRANQUILLA;Everglades, Estados Unidos;550;400;3.800,00;1.700,00
EXTRUSION 6063;0;0;0;0;0;ESTADOS UNIDOS, MIAMI;Pennsylvania, Estados Unidos;0;0;0;1700
ALUMINIO T/T;720;1.750;500;55;50;VENEZUELA, LA GUAIRA;Nhava Sheva, India;;;;
PAILAS DE ALUMINIO;1.459;1.750;500;55;50;VENEZUELA, LA GUAIRA;Bilbao, España;;;;
PAILAS DE ALUMINIO;1.177;1.750;500;55;50;VENEZUELA, LA GUAIRA;Estambul, Turquia;;;;
PAILAS DE ALUMINIO;240;1.750;500;55;50;VENEZUELA, LA GUAIRA;Laem Chabang, Tailandia;;;;
PAILAS DE ALUMINIO;60;1.750;500;55;50;VENEZUELA, LA GUAIRA;Ningbo, China;;;;
PERFIL ALUM;1.282;1.750;500;55;50;VENEZUELA, LA GUAIRA;Everglades, Estados Unidos;550;400;1.200,00;1.700,00
RIN DE ALUMINIO;1.282;1.750;500;55;50;VENEZUELA, LA GUAIRA;Everglades, Estados Unidos;550;400;1.100,00;1.100,00
HVAC;0;0;0;0;0;ESTADOS UNIDOS, MIAMI;Frisco City, Estados Unidos;;;;
UBC;1.282;1.750;500;55;50;VENEZUELA, LA GUAIRA;Everglades, Estados Unidos;550;400;1.100,00;1.100,00
UBC;170;1.750;500;55;50;VENEZUELA, LA GUAIRA;Laem Chabang, Tailandia;;;;
FOIL;1.836;1.900;500;55;50;VENEZUELA, LA GUAIRA;Bilbao, España;;;;
ACERO;80;2.050;500;55;50;VENEZUELA, LA GUAIRA;Kaohsiung, Taiwan;;;;
ACR;170;3.550;500;55;50;VENEZUELA, LA GUAIRA;Laem Chabang, Tailandia;;;;
COBRE;1.282;11.500;500;55;50;VENEZUELA, LA GUAIRA;Everglades, Estados Unidos;550;450;1.600,00;1.950,00
SEAL UNITS;0;0;0;0;0;ESTADOS UNIDOS, MIAMI;Frisco City, Estados Unidos;550;;;
COBRE;60;11.500;500;55;50;VENEZUELA, LA GUAIRA;Gaoming, China;;;;
</script>

<script>
    let db = [];
    const LBS_TO_TM = 2204.62;

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(';').map(h => h.trim());
        const result = [];
        for(let i=1; i<lines.length; i++) {
            const currentline = lines[i].split(';');
            if(currentline.length < 2) continue;
            let obj = {};
            for(let j=0; j<headers.length; j++) {
                let val = currentline[j] ? currentline[j].trim() : '';
                if(val === '-' || val === '') val = '0';
                obj[headers[j]] = val;
            }
            result.push(obj);
        }
        return result;
    }

    function cleanNum(str) {
        if(typeof str === 'number') return str;
        return parseFloat(str.replace(/\./g, '').replace(/,/g, '.')) || 0;
    }

    function fmt(num, isMoney=true) {
        return new Intl.NumberFormat('en-US', { 
            style: isMoney ? 'currency' : 'decimal', 
            currency: 'USD',
            maximumFractionDigits: 2 
        }).format(num);
    }

    const dom = {
        mat: document.getElementById('material'),
        dest: document.getElementById('destino'),
        qty: document.getElementById('quantity'),
        unit: document.getElementById('unit'),
        buy: document.getElementById('purchasePrice'),
        sell: document.getElementById('salePrice'),
        margin: document.getElementById('profitMargin'),
        manual: document.getElementById('manualCost'),
        pickup: document.getElementById('pickupOverride'),
        btn: document.getElementById('btnCalculate'),
        results: document.getElementById('resultsArea'),
        details: document.getElementById('detailsList'),
        suggestions: document.getElementById('suggestionsContainer'),
        manualWarning: document.getElementById('manualWarning')
    };

    function init() {
        const rawData = document.getElementById('csv-data').textContent;
        const rows = parseCSV(rawData);
        const unique = new Set();
        db = rows.filter(row => {
            const key = row['MATERIAL'] + '|' + row['PAIS Y PUERTO DESTINO'];
            const isDup = unique.has(key);
            unique.add(key);
            return !isDup;
        });

        const mats = [...new Set(db.map(x => x['MATERIAL']))].sort();
        dom.mat.innerHTML = '<option value="">-- Seleccione Material --</option>';
        mats.forEach(m => dom.mat.add(new Option(m, m)));
    }

    dom.mat.addEventListener('change', () => {
        const val = dom.mat.value;
        dom.dest.innerHTML = '<option value="">-- Seleccione Destino --</option>';
        dom.dest.disabled = !val;
        if(val) {
            const dests = db.filter(r => r['MATERIAL'] === val).map(r => r['PAIS Y PUERTO DESTINO']).sort();
            dests.forEach(d => dom.dest.add(new Option(d, d)));
        }
        dom.results.classList.add('hidden');
    });

    dom.unit.addEventListener('change', () => {
        const u = dom.unit.value;
        document.getElementById('lblBuy').textContent = `Compra (USD/${u})`;
        document.getElementById('lblSell').textContent = `Venta (USD/${u})`;
        document.getElementById('lblLogisticUnit').textContent = `Costo por ${u}:`;
    });

    function calculate() {
        if(!dom.mat.value || !dom.dest.value) {
            if(dom.results.classList.contains('hidden')) alert('Seleccione Material y Destino');
            return;
        }
        
        const q = parseFloat(dom.qty.value) || 0;
        if(q <= 0) { 
             if(dom.results.classList.contains('hidden')) alert('Ingrese cantidad válida'); 
             return; 
        }

        const row = db.find(r => r['MATERIAL'] === dom.mat.value && r['PAIS Y PUERTO DESTINO'] === dom.dest.value);
        if(!row) return;

        const isLbs = dom.unit.value === 'LBS';
        const tons = isLbs ? q / LBS_TO_TM : q;
        const containers = Math.ceil(tons / 27.5);

        // Costos
        const c = {
            ocean: cleanNum(row['FLETE MARITIMO']),
            salida: cleanNum(row['SALIDA']),
            bolipuerto: cleanNum(row['BOLIPUERTO']),
            inter: cleanNum(row['INTER SHIP']),
            com: cleanNum(row['COMISION']),
            acarreo: cleanNum(row['ACARREO']),
            kci: cleanNum(row['KCI']),
            arancel: cleanNum(row['ARANCEL']),
            miami: cleanNum(row['FLETE MIAMI']),
            pickup: dom.pickup.checked ? 500 : 0
        };

        const costPerCont = c.ocean + c.salida + c.bolipuerto + c.inter + c.com + c.acarreo + c.kci + c.arancel + c.miami + c.pickup;
        let totalLog = costPerCont * containers;

        // Manual Override
        const manual = parseFloat(dom.manual.value);
        const hasManual = !isNaN(manual) && manual > 0;
        
        if(hasManual) {
            totalLog = manual;
            dom.manualWarning.classList.remove('hidden');
        } else {
            dom.manualWarning.classList.add('hidden');
        }

        const logUnit = totalLog / q;

        const pBuy = parseFloat(dom.buy.value) || 0;
        const pSell = parseFloat(dom.sell.value) || 0;
        const totalBuy = q * pBuy;
        const totalSell = q * pSell;
        const totalCost = totalBuy + totalLog;
        const gross = totalSell - totalCost;
        const roi = totalCost > 0 ? (gross / totalCost) * 100 : 0;

        // Sugerencias
        const margin = parseFloat(dom.margin.value) || 0;
        if (margin > 0) {
            dom.suggestions.classList.remove('hidden');
            const unitCostTotal = pBuy + logUnit;
            const idealSell = margin < 100 ? unitCostTotal / (1 - (margin/100)) : 0;
            const idealBuy = pSell - logUnit - (pSell * (margin/100));
            document.getElementById('resIdealSell').textContent = fmt(idealSell);
            document.getElementById('resIdealBuy').textContent = fmt(idealBuy);
        } else {
            dom.suggestions.classList.add('hidden');
        }

        // Render UI
        document.getElementById('resTotalLogistic').textContent = fmt(totalLog);
        document.getElementById('resLogisticUnit').textContent = fmt(logUnit);
        document.getElementById('resContainers').textContent = containers;
        
        document.getElementById('resGrossProfit').textContent = fmt(gross);
        document.getElementById('resGrossProfit').className = gross >= 0 ? 'text-success' : 'text-danger';
        
        document.getElementById('resRoi').textContent = roi.toFixed(1) + '%';
        document.getElementById('resRoi').className = roi >= 0 ? 'text-success' : 'text-danger';

        renderDetails(c, costPerCont);
        dom.results.classList.remove('hidden');
        
        // Scroll a resultados si es móvil
        if(window.innerWidth < 600) {
            dom.results.scrollIntoView({behavior: 'smooth', block: 'start'});
        }
    }

    function renderDetails(c, total) {
        let html = '';
        const add = (lbl, val) => {
            if(val > 0) html += `<div class="row-item"><span class="text-light">${lbl}</span><span>${fmt(val)}</span></div>`;
        };
        
        const manual = parseFloat(dom.manual.value);
        if(!isNaN(manual) && manual > 0) {
            dom.details.innerHTML = '<div style="text-align:center; color:var(--brand-red); padding:10px; font-style:italic">Desglose desactivado por ajuste manual</div>';
            return;
        }

        add('Flete Marítimo', c.ocean);
        add('Salida', c.salida);
        add('Bolipuerto', c.bolipuerto);
        add('Inter Ship', c.inter);
        add('Comisión', c.com);
        add('Acarreo (USA)', c.acarreo);
        add('KCI (USA)', c.kci);
        add('Arancel (USA)', c.arancel);
        add('Flete Miami', c.miami);
        add('Recogida Proveedor', c.pickup);
        
        html += `<div class="row-item highlight" style="margin-top:5px"><span>TOTAL / CONTENEDOR</span><span>${fmt(total)}</span></div>`;
        dom.details.innerHTML = html;
    }

    dom.btn.addEventListener('click', calculate);
    
    dom.pickup.addEventListener('change', () => {
        if(!dom.results.classList.contains('hidden')) calculate();
    });

    dom.manual.addEventListener('input', () => {
        if(!dom.results.classList.contains('hidden')) calculate();
    });
    
    dom.margin.addEventListener('input', () => {
         if(!dom.results.classList.contains('hidden')) calculate();
    });

    init();
</script>

</body>
</html>
